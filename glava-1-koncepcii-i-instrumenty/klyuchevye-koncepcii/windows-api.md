# Windows API

Интерфейс прикладного программирования Windows (API) — это интерфейс пользовательского режима системного программирования для семейства операционных систем Windows. До появления 64-разрядных версий Windows программный интерфейс для 32-разрядных версий Windows OS назывался Win32 API, чтобы отличать его от оригинального 16-разрядного Windows API, который был программным интерфейсом для оригинальных 16-разрядных версий Windows. В этой книге термин Windows API относится как к 32-разрядным, так и к 64-разрядным программным интерфейсам Windows.

### Форматы Windows API

Windows API изначально состоял только из функций в стиле C. Сегодня существует множество таких функций, которые разработчики могут использовать. C был естественным выбором в момент создания Windows, так как это был наименьший общий знаменатель (то есть к нему могли обращаться из других языков) и он был достаточно низкоуровневым, чтобы обеспечить доступ к сервисам ОС. Недостатком являлось большое количество функций вместе с отсутствием согласованности в наименовании и логической группировке (например, пространствами имен в C++). В результате этих трудностей в некоторых новых API используется другой механизм: модель COM (Component Object Model).

COM изначально была создана для того, чтобы приложения Microsoft Office могли обмениваться данными между документами (например, встраивание диаграммы из Excel в документ Word или презентацию PowerPoint). Эта возможность называется связывание и встраивание объектов (OLE). OLE первоначально была реализована с помощью старого механизма обмена сообщениями в Windows под названием Dynamic Data Exchange (DDE), который имел свои ограничения, и поэтому был разработан новый способ коммуникации: COM. COM изначально называлась OLE 2, выпущенная около 1993 года.

COM основывается на двух ключевых принципах. Во-первых, клиенты взаимодействуют с объектами (иногда называемыми COM-серверами) через интерфейсы — четко определенные соглашения с набором логически связанных методов, сгруппированных в рамках механизма виртуальной таблицы, который также часто используется компиляторами C++ для реализации диспетчеризации виртуальных функций. Это гарантирует бинарную совместимость и устранение проблем с конфликтами имен в компиляторах. Таким образом, можно вызывать эти методы из многих языков и компиляторов, таких как C, C++, Visual Basic, .NET языки, Delphi и другие. Второй принцип заключается в том, что реализация компонента загружается динамически, а не статически связана с клиентом. Термин COM-сервер обычно относится к динамически загружаемой библиотеке (DLL) или исполняемому файлу (EXE), где реализованы классы COM. COM имеет другие важные особенности, связанные с безопасностью, межпроцессной взаимодействием, моделью потоков и многим другим. Комплексное описание COM выходит за рамки этой книги; отличное описание COM можно найти в книге Essential COM Дона Бокса (Addison-Wesley, 1998).

### Windows Runtime

В Windows 8 представили новый API и поддержку среды выполнения под названием Windows Runtime (иногда сокращается как WinRT, не путать с Windows RT, прекращенной версией Windows для ARM). Windows Runtime состоит из платформенных сервисов, предназначенных в основном для разработчиков приложений для так называемых Windows Apps (ранее известных как Metro Apps, Modern Apps, Immersive Apps и Windows Store Apps). Windows Apps могут быть нацелены на разные устройства, от маленьких IoT устройств до телефонов, планшетов, ноутбуков, настольных ПК и даже таких устройств как Xbox One и Microsoft HoloLens.

С точки зрения API, WinRT построен на основе COM, добавляющего различные расширения к базовой инфраструктуре COM. Например, в WinRT доступны полные метаданные типов (хранятся в файлах WINMD и основаны на формате метаданных .NET), расширяющие подобную концепцию в COM, известную как библиотеки типов. С точки зрения проектирования API, он гораздо более целостен, чем классические функции Windows API, с иерархиями пространств имен, последовательными наименованиями и программными шаблонами.

Windows Apps подчиняются новым правилам, в отличие от обычных приложений Windows (теперь называемых Windows desktop applications или Classic Windows applications). Эти правила описаны в Главе 9, «Механизмы управления», в Части 2.

Отношения между различными API и приложениями не являются прямолинейными. Настольные приложения могут использовать подмножество API WinRT. В свою очередь, Windows Apps могут использовать подмножество Win32 и COM API. Обратитесь к документации MSDN для подробностей о том, какие API доступны для каждой платформы приложений. Заметьте, тем не менее, что на базовом двоичном уровне API WinRT все еще основан на традиционных бинарных файлах и API Windows, даже если доступность некоторых API может не быть документирована или поддерживать. Это не новый «родной» API для системы, так же как и .NET все еще использует традиционный Windows API.

Приложения, написанные на C++, C# (или других языках .NET), и JavaScript, могут легко использовать API WinRT благодаря языковым проекциям, разработанным для этих платформ. Для C++ Microsoft создала нестандартное расширение, известное как C++/CX, которое упрощает использование типов WinRT. Обычный слой взаимодействия COM для .NET (с некоторыми поддерживающими расширениями времени выполнения) позволяет любому .NET языку использовать API WinRT естественно и просто, как будто это чистый .NET. Для разработчиков на JavaScript было разработано расширение под названием WinJS для доступа к WinRT, хотя разработчики на JavaScript должны по-прежнему использовать HTML для построения интерфейса пользователя вместе со своим приложением.

### The .NET Framework

.NET Framework является частью Windows. Таблица 1-2 показывает версию .NET Framework, установленную в составе конкретной версии Windows. Однако более позднюю версию .NET Framework можно установить на более старые версии ОС.

| Версия Windows         | Версия .NET Framework |
| ---------------------- | --------------------- |
| Windows 8              | 4.5                   |
| Windows 8.1            | 4.5.1                 |
| Windows 10             | 4.6                   |
| Windows 10 версия 1511 | 4.6.1                 |
| Windows 10 версия 1607 | 4.6.2                 |

.NET Framework состоит из двух основных компонентов:

* **Общее Языковое Время Исполнения (CLR)**: Это двигатель времени исполнения для .NET, включающий JIT-компилятор, который переводит инструкции Common Intermediate Language (CIL) на машинный язык процессора, сборщик мусора, проверку типов, безопасность доступа к коду и многое другое. Реализовано как COM сервер в процессе (DLL) и использует различные возможности, предоставляемые Windows API.
* **Библиотека Классов .NET Framework (FCL)**: Это большая коллекция типов, которые реализуют функциональность, обычно необходимую клиентским и серверным приложениям, такие как пользовательский интерфейс, сетевые службы, доступ к базам данных и многое другое.

