# Виртуальная память

Windows реализует систему виртуальной памяти, основанную на плоском (линейном) адресном пространстве, которое создает у каждого процесса иллюзию наличия собственного большого, приватного адресного пространства. Виртуальная память предоставляет логическое представление памяти, которое может не соответствовать ее физическому расположению. Во время выполнения диспетчер памяти—с помощью аппаратного обеспечения—переводит или _сопоставляет_ виртуальные адреса в физические адреса, где данные фактически хранятся. Благодаря управлению защитой и сопоставлением ОС может гарантировать, что отдельные процессы не мешают друг другу или не затирают данные ОС.&#x20;

Поскольку большинство систем имеет гораздо меньше физической памяти, чем общий объем используемой виртуальной памяти всех работающих процессов, диспетчер памяти перемещает, или _страничит_, некоторые содержимое памяти на диск. Страничение данных на диск освобождает физическую память, чтобы она могла быть использована для других процессов или самой ОС. Когда поток обращается к виртуальному адресу, который был перемещен на диск, диспетчер виртуальной памяти загружает информацию обратно в память с диска.&#x20;

Приложения не нужно изменять, чтобы воспользоваться преимуществами страничения, поскольку аппаратная поддержка позволяет диспетчеру памяти выполнять страничение без знания или участия процессов или потоков. На Рисунке 1-3 показаны два процесса, использующие виртуальную память, в которой части сопоставлены с физической памятью (ОЗУ), в то время как другие части перемещены на диск. Обратите внимание, что смежные куски виртуальной памяти могут быть сопоставлены с несмежными кусками в физической памяти. Эти куски называются страницами и имеют стандартный размер 4 KB.

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Размер виртуального адресного пространства варьируется для каждой аппаратной платформы. На 32-битных системах x86 общее виртуальное адресное пространство имеет теоретический максимум в 4 ГБ. По умолчанию, Windows выделяет нижнюю половину этого адресного пространства (адреса от 0x00000000 до 0x7FFFFFFF) для процессов для их уникального частного хранения и верхнюю половину (адреса от 0x80000000 до 0xFFFFFFFF) для своей собственной защищенной памяти ОС. Отображение нижней половины изменяется, чтобы отражать виртуальное адресное пространство текущего выполняемого процесса, но (большинство) отображений верхней половины всегда состоит из виртуальной памяти ОС. Windows поддерживает опции загрузки, такие как параметр increaseuserva в базе данных конфигурации загрузки, которые дают процессам, выполняющимся под специальными программами, возможность использовать до 3 ГБ частного адресного пространства, оставляя 1 ГБ для ОС. (Под «специально отмеченными» мы понимаем, что флаг большой адресной области должен быть установлен в заголовке исполняемого образа.) Эта опция позволяет приложениям, таким как серверы баз данных, удерживать большие части базы данных в адресном пространстве процесса, снижая необходимость отображения подмножеств базы данных на диск и, следовательно, увеличивая общую производительность (хотя в некоторых случаях потеря 1 ГБ для системы может вызвать более выраженные общесистемные потери производительности).

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Хотя 3 ГБ лучше, чем 2 ГБ, этого все равно недостаточно, чтобы спроецировать очень большие (многогигабайтные) базы данных. Чтобы решить эту проблему на 32-битных системах, Windows предоставляет механизм, называемый _Address Windowing Extensions_ (_AWE_), который позволяет 32-битному приложению выделять до 64 ГБ физической памяти и затем отображать представления или окна в свой виртуальный адресное пространство размером 2 ГБ. Хотя использование AWE возлагает на разработчика бремя управления отображением виртуальной памяти в физическую, оно решает необходимость прямого доступа к большему объему физической памяти, чем можно сопоставить в любой момент времени в адресном пространстве процесса 32-битной версии.&#x20;

64-битная версия Windows предоставляет гораздо большее адресное пространство для процессов: 128 ТБ в Windows 8.1, Server 2012 R2 и более поздних системах. Рисунок 1-5 демонстрирует упрощенный вид адресного пространства 64-битной системы. (Подробное описание см. в главе 5.) Обратите внимание, что эти размеры не представляют собой архитектурные ограничения для этих платформ. Шестьдесят четыре бита адресного пространства — это 2 в 64-й степени или 16 ЭБ (где 1 ЭБ равен 1 024 ПБ или 1 048 576 ТБ), но текущее 64-битное оборудование ограничивает это меньшими значениями. Неотображаемая область, указанная на рисунке 1-5, намного больше, чем возможная отображаемая область (примерно в миллион раз больше в Windows 8), что означает, что изображения (в значительно) не в масштабе.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Подробности реализации менеджера памяти, включая работу адресного перевода и управление физической памятью в Windows, описаны в Главе 5.
